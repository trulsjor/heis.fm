---
import Layout from '../../layouts/Layout.astro';
import { RSS_FEED_URL } from '../../config';
import { parseRssFeed } from '../../utils/rss';
import type { Episode } from '../../utils/rss';
import ListenPlatforms from '../../components/ListenPlatforms.astro';

export async function getStaticPaths() {
  const episodes = await parseRssFeed(RSS_FEED_URL);

  // Reverse to get oldest first, then assign numbers starting from 0
  const reversedEpisodes = [...episodes].reverse();

  return reversedEpisodes.map((episode, index) => ({
    params: { number: index.toString() },
    props: {
      episode,
      episodeNumber: index,
      totalEpisodes: episodes.length,
      prevEpisode: index > 0 ? reversedEpisodes[index - 1] : null,
      nextEpisode: index < episodes.length - 1 ? reversedEpisodes[index + 1] : null,
    },
  }));
}

interface Props {
  episode: Episode;
  episodeNumber: number;
  totalEpisodes: number;
  prevEpisode: Episode | null;
  nextEpisode: Episode | null;
}

const { episode, episodeNumber, totalEpisodes, prevEpisode, nextEpisode } = Astro.props;

// Format date in Norwegian
const date = new Date(episode.pubDate);
const formattedDate = date.toLocaleDateString('nb-NO', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<Layout
  title={`Episode ${episodeNumber}: ${episode.title} - heis.fm`}
  description={episode.description}
>
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <!-- Episode header -->
    <div class="mb-8">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-pink font-bold text-2xl">
          #{ episodeNumber }
        </span>
        <time datetime={episode.pubDate} class="text-gray-400">
          {formattedDate}
        </time>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold mb-2">{episode.title}</h1>
      {episode.subtitle && (
        <p class="text-xl text-gray-400 mb-4">{episode.subtitle}</p>
      )}
    </div>

    <!-- Episode image -->
    {episode.imageUrl && (
      <div class="mb-8 rounded-lg overflow-hidden border border-gray-800">
        <img
          src={episode.imageUrl}
          alt={episode.title}
          class="w-full aspect-square object-cover"
        />
      </div>
    )}

    <!-- Audio player -->
    {episode.audioUrl && (
      <div class="mb-8 p-6 bg-gray-900 rounded-lg border border-gray-800">
        <audio controls preload="metadata" class="w-full">
          <source src={episode.audioUrl} type="audio/mpeg" />
          Nettleseren din støtter ikke audio-elementet.
        </audio>
      </div>
    )}

    <!-- Episode description -->
    <div class="prose prose-invert prose-pink max-w-none mb-12">
      <div class="text-lg text-gray-300 leading-relaxed" set:html={episode.description} />
    </div>

    <!-- Navigation -->
    <nav class="border-t border-gray-800 pt-8 mt-12">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        {prevEpisode ? (
          <a
            href={`/episode/${episodeNumber - 1}`}
            class="group bg-gray-900 hover:bg-gray-800 border border-gray-800 rounded-lg p-4 transition-colors"
          >
            <div class="text-sm text-gray-400 mb-1">← Forrige</div>
            <div class="font-semibold text-white group-hover:text-pink transition-colors line-clamp-2">
              {prevEpisode.title}
            </div>
            {prevEpisode.subtitle && (
              <div class="text-sm text-gray-400 mt-1 line-clamp-1">{prevEpisode.subtitle}</div>
            )}
          </a>
        ) : (
          <div></div>
        )}

        <a
          href="/episodes"
          class="flex items-center justify-center bg-gray-900 hover:bg-gray-800 border border-gray-800 rounded-lg p-4 transition-colors text-gray-400 hover:text-white font-semibold"
        >
          Alle episoder
        </a>

        {nextEpisode ? (
          <a
            href={`/episode/${episodeNumber + 1}`}
            class="group bg-gray-900 hover:bg-gray-800 border border-gray-800 rounded-lg p-4 transition-colors text-right"
          >
            <div class="text-sm text-gray-400 mb-1">Neste →</div>
            <div class="font-semibold text-white group-hover:text-pink transition-colors line-clamp-2">
              {nextEpisode.title}
            </div>
            {nextEpisode.subtitle && (
              <div class="text-sm text-gray-400 mt-1 line-clamp-1">{nextEpisode.subtitle}</div>
            )}
          </a>
        ) : (
          <div></div>
        )}
      </div>
    </nav>
    <ListenPlatforms />
  </article>
</Layout>
